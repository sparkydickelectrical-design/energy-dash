<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Energy Hub | Fixed</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #000; --card: #0d0d0d;
            --green: #4ade80; --blue: #3b82f6; --red: #ef4444;
        }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        
        .sidebar { width: 70px; background: #080808; border-right: 1px solid #111; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .main { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* Hub Section */
        .hub-area { position: relative; width: 400px; height: 350px; margin-bottom: 20px; }
        .svg-box { position: absolute; width: 100%; height: 100%; top: 0; left: 0; }
        
        /* Dashed Lines */
        .line { stroke: #222; stroke-width: 3; stroke-dasharray: 6; fill: none; transition: stroke 0.3s; }
        .flow-in { animation: f-in 1s linear infinite; }
        .flow-out { animation: f-out 1s linear infinite; }
        @keyframes f-in { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }
        @keyframes f-out { from { stroke-dashoffset: 0; } to { stroke-dashoffset: 20; } }

        /* Node Styling */
        .node { position: absolute; transform: translate(-50%, -50%); text-align: center; }
        .circ { width: 55px; height: 55px; background: #000; border: 2px solid #222; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .circ i { width: 16px; height: 16px; color: #444; margin-bottom: 2px; }
        .circ span { font-size: 0.8rem; font-weight: bold; }
        .lbl { font-size: 0.6rem; color: #666; margin-top: 5px; font-weight: bold; }

        /* Node Positions */
        .p-center { top: 50%; left: 50%; }
        .p-solar { top: 10%; left: 50%; }
        .p-wind { top: 25%; left: 85%; }
        .p-hp { top: 55%; left: 15%; }
        .p-batt { top: 55%; left: 85%; }
        .p-home { top: 85%; left: 75%; }
        .p-ev { top: 85%; left: 25%; }
        .p-grid { top: 25%; left: 15%; }

        /* Sliders */
        .controls { background: var(--card); padding: 20px; border-radius: 12px; width: 500px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .s-box { display: flex; flex-direction: column; gap: 4px; }
        .s-label { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; }
    </style>
</head>
<body>

    <div class="sidebar"><i data-lucide="zap" style="color:var(--green)"></i></div>

    <div class="main">
        <div class="hub-area">
            <svg class="svg-box" viewBox="0 0 400 350">
                <line id="l-solar" x1="200" y1="175" x2="200" y2="35" class="line" />
                <line id="l-wind" x1="200" y1="175" x2="340" y2="87" class="line" />
                <line id="l-hp" x1="200" y1="175" x2="60" y2="192" class="line" />
                <line id="l-batt" x1="200" y1="175" x2="340" y2="192" class="line" />
                <line id="l-home" x1="200" y1="175" x2="300" y2="297" class="line" />
                <line id="l-ev" x1="200" y1="175" x2="100" y2="297" class="line" />
                <line id="l-grid" x1="200" y1="175" x2="60" y2="87" class="line" />
            </svg>

            <div class="node p-center"><div class="circ" style="border-color:var(--blue)"><i data-lucide="cpu" style="color:var(--blue)"></i></div></div>
            
            <div class="node p-solar"><div class="circ" id="n-solar"><i data-lucide="sun"></i><span id="txt-solar">0.0</span></div><div class="lbl">SOLAR</div></div>
            <div class="node p-wind"><div class="circ" id="n-wind"><i data-lucide="wind"></i><span id="txt-wind">0.0</span></div><div class="lbl">WIND</div></div>
            <div class="node p-hp"><div class="circ" id="n-hp"><i data-lucide="thermometer"></i><span id="txt-hp">0.0</span></div><div class="lbl">HEAT PUMP</div></div>
            <div class="node p-batt"><div class="circ" id="n-batt"><i data-lucide="battery"></i><span id="txt-batt">0.0</span></div><div class="lbl">BATT</div></div>
            <div class="node p-home"><div class="circ" id="n-home"><i data-lucide="home"></i><span id="txt-home">0.0</span></div><div class="lbl">HOME</div></div>
            <div class="node p-ev"><div class="circ" id="n-ev"><i data-lucide="car"></i><span id="txt-ev">0.0</span></div><div class="lbl">EV</div></div>
            <div class="node p-grid"><div class="circ" id="n-grid"><i data-lucide="utility-pole"></i><span id="txt-grid">0.0</span></div><div class="lbl">GRID</div></div>
        </div>

        <div class="controls">
            <div class="s-box"><div class="s-label">Solar <span id="val-solar">0.0</span></div><input type="range" class="slider" id="in-solar" min="0" max="10" step="0.1" value="5"></div>
            <div class="s-box"><div class="s-label">Wind <span id="val-wind">0.0</span></div><input type="range" class="slider" id="in-wind" min="0" max="10" step="0.1" value="2"></div>
            <div class="s-box"><div class="s-label">HP <span id="val-hp">0.0</span></div><input type="range" class="slider" id="in-hp" min="0" max="5" step="0.1" value="1"></div>
            <div class="s-box"><div class="s-label">Battery <span id="val-batt">0.0</span></div><input type="range" class="slider" id="in-batt" min="-5" max="5" step="0.1" value="0"></div>
            <div class="s-box"><div class="s-label">Home <span id="val-home">0.0</span></div><input type="range" class="slider" id="in-home" min="0" max="10" step="0.1" value="3"></div>
            <div class="s-box"><div class="s-label">EV <span id="val-ev">0.0</span></div><input type="range" class="slider" id="in-ev" min="0" max="7" step="0.1" value="0"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const ids = ['solar', 'wind', 'hp', 'batt', 'home', 'ev'];
            const inputs = {};
            ids.forEach(id => inputs[id] = document.getElementById('in-' + id));

            function refresh() {
                const v = {};
                ids.forEach(id => v[id] = parseFloat(inputs[id].value));

                // Formula: Renewables (Solar+Wind+HP+Batt) vs Demand (Home+EV)
                const production = v.solar + v.wind + v.hp + v.batt;
                const demand = v.home + v.ev;
                const grid = demand - production;

                // Update text and colors for standard nodes
                ids.forEach(id => {
                    const val = v[id];
                    document.getElementById('val-' + id).innerText = val.toFixed(1);
                    document.getElementById('txt-' + id).innerText = val.toFixed(1);
                    
                    const line = document.getElementById('l-' + id);
                    const circ = document.getElementById('n-' + id);
                    const icon = circ.querySelector('i');

                    // logic for color and flow
                    let color = 'var(--blue)';
                    if (['solar', 'wind', 'hp'].includes(id)) color = 'var(--green)';
                    if (id === 'ev') color = val > 0 ? 'var(--green)' : 'var(--red)';

                    if (Math.abs(val) > 0.05) {
                        line.style.stroke = color;
                        // Renewables flow IN, Home/EV flow OUT
                        line.className = ['solar', 'wind', 'hp', 'batt'].includes(id) ? 'line flow-in' : 'line flow-out';
                        circ.style.borderColor = color;
                        icon.style.color = color;
                    } else {
                        line.style.stroke = '#222';
                        line.className = 'line';
                        circ.style.borderColor = '#222';
                        icon.style.color = '#444';
                    }
                });

                // Update Grid Node
                const gLine = document.getElementById('l-grid');
                const gCirc = document.getElementById('n-grid');
                const gTxt = document.getElementById('txt-grid');
                const gIcon = gCirc.querySelector('i');
                const gColor = grid > 0 ? 'var(--red)' : 'var(--green)';

                gTxt.innerText = grid.toFixed(1);
                if (Math.abs(grid) > 0.05) {
                    gLine.style.stroke = gColor;
                    gLine.className = grid > 0 ? 'line flow-in' : 'line flow-out';
                    gCirc.style.borderColor = gColor;
                    gIcon.style.color = gColor;
                } else {
                    gLine.style.stroke = '#222';
                    gLine.className = 'line';
                    gCirc.style.borderColor = '#222';
                    gIcon.style.color = '#444';
                }
            }

            ids.forEach(id => inputs[id].addEventListener('input', refresh));
            refresh(); // initial run
        });
    </script>
</body>
</html>
